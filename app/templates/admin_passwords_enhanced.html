{% extends "base.html" %}

{% block title %}Admin - User Passwords (Developer Mode){% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-key me-2"></i>User Password Management
        </h1>
        <div>
            <a href="{{ url_for('main.admin_dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Developer Mode Warning -->
    <div class="alert alert-danger mb-4">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>DEVELOPER MODE ACTIVE</strong> - Plain text passwords are visible. 
        <strong>Never enable this in production!</strong>
        <div class="mt-2">
            <small>
                <i class="fas fa-info-circle me-1"></i>
                This feature is for learning and development purposes only.
            </small>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-left-warning shadow h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Developer Mode
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">ACTIVE</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-code fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-info shadow h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Users
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ users|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-success shadow h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Passwords Visible
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ users|selectattr('plain_password')|list|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-eye fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">User Credentials (Plain Text Visible)</h6>
            <button class="btn btn-sm btn-outline-info" onclick="toggleAllPasswords()">
                <i class="fas fa-eye me-1"></i> Toggle All Passwords
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="usersTable">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>User Type</th>
                            <th>Password Hash</th>
                            <th>Plain Password</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>
                                <strong>{{ user.username }}</strong>
                                {% if user.is_admin %}
                                <span class="badge bg-danger ms-1">Admin</span>
                                {% endif %}
                            </td>
                            <td>{{ user.email }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if user.user_type == 'organization' else 'primary' }}">
                                    {{ user.user_type }}
                                </span>
                            </td>
                            <td>
                                <small>
                                    <code class="password-hash">{{ user.password_hash[:30] }}...</code>
                                    <button class="btn btn-sm btn-outline-secondary view-hash-btn" 
                                            data-full-hash="{{ user.password_hash }}">
                                        <i class="fas fa-expand me-1"></i> Full
                                    </button>
                                </small>
                            </td>
                            <td>
                                <div class="password-display">
                                    <span class="plain-password" style="display: none;">
                                        <code class="text-success">{{ user.get_plain_password() }}</code>
                                    </span>
                                    <span class="password-placeholder">
                                        <button class="btn btn-sm btn-outline-warning show-password-btn"
                                                data-user-id="{{ user.id }}"
                                                data-username="{{ user.username }}">
                                            <i class="fas fa-eye me-1"></i> Reveal
                                        </button>
                                    </span>
                                </div>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-info reset-password-btn"
                                            data-user-id="{{ user.id }}"
                                            data-username="{{ user.username }}">
                                        <i class="fas fa-redo me-1"></i> Reset
                                    </button>
                                    {% if user.id != current_user.id %}
                                    <button class="btn btn-outline-danger delete-user-btn"
                                            data-user-id="{{ user.id }}"
                                            data-username="{{ user.username }}">
                                        <i class="fas fa-trash me-1"></i> Delete
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Security Notes -->
    <div class="row">
        <div class="col-12">
            <div class="card border-left-danger">
                <div class="card-body">
                    <h6 class="card-title text-danger">
                        <i class="fas fa-shield-alt me-2"></i>Security Best Practices
                    </h6>
                    <ul class="small text-muted mb-0">
                        <li>Never store plain text passwords in production</li>
                        <li>Use environment variables for configuration</li>
                        <li>Regularly audit and rotate secrets</li>
                        <li>Enable two-factor authentication in production</li>
                        <li>Use HTTPS in production environments</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Password Reset Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset User Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Reset password for user: <strong id="reset-username"></strong></p>
                <div class="mb-3">
                    <label for="newPassword" class="form-label">New Password</label>
                    <input type="text" class="form-control" id="newPassword" value="Temp123!">
                    <div class="form-text">This password will be stored in plain text while developer mode is active.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmReset">Reset Password</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allPasswordsVisible = false;

function toggleAllPasswords() {
    const passwordDisplays = document.querySelectorAll('.password-display');
    const toggleBtn = document.querySelector('button[onclick="toggleAllPasswords()"]');
    
    allPasswordsVisible = !allPasswordsVisible;
    
    passwordDisplays.forEach(display => {
        const plainPassword = display.querySelector('.plain-password');
        const placeholder = display.querySelector('.password-placeholder');
        
        if (allPasswordsVisible) {
            plainPassword.style.display = 'inline';
            placeholder.style.display = 'none';
        } else {
            plainPassword.style.display = 'none';
            placeholder.style.display = 'inline';
        }
    });
    
    toggleBtn.innerHTML = allPasswordsVisible ? 
        '<i class="fas fa-eye-slash me-1"></i> Hide All Passwords' :
        '<i class="fas fa-eye me-1"></i> Show All Passwords';
}

document.addEventListener('DOMContentLoaded', function() {
    // Show individual password
    document.querySelectorAll('.show-password-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const username = this.getAttribute('data-username');
            const display = this.closest('.password-display');
            const plainPassword = display.querySelector('.plain-password');
            const placeholder = display.querySelector('.password-placeholder');
            
            if (confirm(`Reveal password for "${username}"?`)) {
                plainPassword.style.display = 'inline';
                placeholder.style.display = 'none';
            }
        });
    });

    // Show full hash
    document.querySelectorAll('.view-hash-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const fullHash = this.getAttribute('data-full-hash');
            alert(`Full Password Hash:\n\n${fullHash}`);
        });
    });

    // Password reset functionality
    let currentResetUserId = null;
    
    document.querySelectorAll('.reset-password-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentResetUserId = this.getAttribute('data-user-id');
            const username = this.getAttribute('data-username');
            
            document.getElementById('reset-username').textContent = username;
            const modal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
            modal.show();
        });
    });

    document.getElementById('confirmReset').addEventListener('click', async function() {
        if (!currentResetUserId) return;
        
        const newPassword = document.getElementById('newPassword').value;
        
        try {
            const response = await fetch(`/api/admin/user/${currentResetUserId}/reset-password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    new_password: newPassword
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert('Password reset successfully!');
                bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error resetting password');
        }
    });

    // Delete user functionality
    document.querySelectorAll('.delete-user-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const username = this.getAttribute('data-username');
            
            if (confirm(`Permanently delete user "${username}"? This cannot be undone!`)) {
                fetch(`/api/admin/user/${userId}/delete`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert('User deleted successfully!');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error deleting user');
                });
            }
        });
    });
});
</script>

<style>
.password-hash {
    font-size: 0.7rem;
    background: #f8f9fa;
    padding: 3px 6px;
    border-radius: 3px;
    font-family: monospace;
}

.plain-password code {
    background: #d4edda;
    padding: 3px 6px;
    border-radius: 3px;
    font-family: monospace;
    font-weight: bold;
}

.table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.alert-danger {
    border-left: 4px solid #dc3545;
}
</style>
{% endblock %}